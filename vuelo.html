<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selección de Vuelos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        header {
            background-color: #1B1B1B;
            color: white;
            padding: 4%;
            display: flex;
            justify-content: center;
            position: relative;
        }

        .promo-card {
            border: 2px solid #34c759;
            border-radius: 10px;
            padding: 20px;
            max-width: 400px;
            background-color: #fff;
            display: flex;
            gap: 12px;
            align-items: center;
            margin: 5%;
        }

        .promo-card p {
            margin: 0;
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }

        .flight-info {
            padding: 4%;
        }

        .flight-route {
            display: flex;
            margin-top: 2%;
            margin-bottom: 4%;
            align-items: center;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 5px 5px 0 0;
            margin: 0 2px;
        }

        .tab.active {
            background: #34c759;
            color: white;
            border-color: #34c759;
        }

        .flight-card {
            border: 1px solid #e0e0e085;
            border-radius: 30px;
            padding: 30px;
            padding-bottom: 1px;
            margin: 5%;
            margin-top: 0;
            max-width: 350px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .flight-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .flight-times {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 10px;
        }

        .time {
            text-align: center;
        }

        .time span {
            display: block;
            font-size: 16px;
            color: #333;
        }

        .duration {
            text-align: center;
        }

        .duration .direct {
            font-size: 14px;
            color: #00a86b;
            font-weight: bold;
        }

        .duration .time {
            font-size: 12px;
            color: #888;
        }

        .operator {
            text-align: center;
            font-size: 14px;
            color: #555;
            margin-bottom: 20px;
        }

        .price {
            text-align: center;
            margin-bottom: 10px;
        }

        .price-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 4%;
        }

        .currency {
            margin-right: 2%;
            font-weight: bold;
        }

        .amount {
            font-size: 2rem;
            color: #000;
            font-weight: bold;
        }

        .flight-cards-container {
            display: flex;
            justify-content: center;
            flex-direction: column;
            width: 90%;
            max-width: 600px;
        }

        .container {
            display: flex;
            justify-content: center;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #34c759;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sort-controls {
            display: flex;
            justify-content: center;
            margin: 10px 5%;
            gap: 10px;
        }

        .sort-button {
            padding: 8px 15px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .sort-button:hover {
            background-color: #e0e0e0;
        }

        .sort-button.active {
            background-color: #34c759;
            color: white;
            border-color: #34c759;
        }

        .toggle-currency {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 10px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .trip-type {
            display: none;
        }

        .trip-type.active {
            display: block;
        }

        .lifemiles-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #34c759;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body onload="inicializar()">
    <header>
        <h4 style="margin: 0;">Selección de vuelos</h4>
        <button class="toggle-currency" onclick="toggleCurrency()">
            <span id="currencyIndicator">CLP/USD</span>
        </button>
    </header>
    
  
    <!-- Promotion Card - Changes based on tab -->
    <div id="promo-ida" class="promo-card trip-type active">
        <div>
            <i class="fa-solid fa-tag" style="font-size: 24px; color: #34c759;"></i>
        </div>
        <p style="font-weight: bold; font-size: 1rem; line-height: 1.2; text-align: justify;">
            Por favor, tenga en cuenta que los vuelos promocionales no incluyen la posibilidad de seleccionar asientos.
        </p>
    </div>
    
    <div id="promo-vuelta" class="promo-card trip-type">
        <div class="lifemiles-logo">
            <i class="fa-solid fa-plane" style="font-size: 20px;"></i>
        </div>
        <p style="font-weight: bold; font-size: 1rem; line-height: 1.2; text-align: justify;">
            Aprovecha la oportunidad de sumar millas en tu viaje, 
            compra la tarifa basic o light y acumula 3 lifemiles por cada USD.
        </p>
    </div>
    
    <!-- Ida (Outbound) flights section -->
    <div id="ida-section" class="trip-type active">
        <div class="flight-info">
            <p style="margin: 0; font-weight: normal; font-size: 1.3rem; color: #252525;">Vuelta</p>
            <div class="flight-route"> 
                <i class="fa-solid fa-plane-departure" style="margin-right: 3%; color: #000000;"></i>
                <p style="margin: 0; font-size: 1.3rem; font-weight: bold;" id="origenIdaPalabra"></p>
                <span style="margin: 0 10px;"><p style="margin: 0; font-size: 1.3rem; font-weight: bold;">a</p></span>
                <p style="margin: 0; font-size: 1.3rem; font-weight: bold;" id="destinoIdaPalabra"></p>
            </div>
        </div>

        <div class="sort-controls">
            <button class="sort-button active" onclick="sortFlights('time', 'ida')">Horario</button>
            <button class="sort-button" onclick="sortFlights('duration', 'ida')">Duración</button>
            <button class="sort-button" onclick="sortFlights('price', 'ida')">Precio</button>
        </div>

        <div class="loader" id="loading-ida"></div>

        <div class="container">
            <div class="flight-cards-container" id="idaFlightCardsContainer">
                <!-- Flight cards will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Vuelta (Return) flights section -->
    <div id="vuelta-section" class="trip-type">
        <div class="flight-info">
            <p style="margin: 0; font-weight: normal; font-size: 1.3rem; color: #252525;">Vuelta</p>
            <div class="flight-route"> 
                <i class="fa-solid fa-plane-departure" style="margin-right: 3%; color: #000000;"></i>
                <p style="margin: 0; font-size: 1.3rem; font-weight: bold;" id="origenVueltaPalabra"></p>
                <span style="margin: 0 10px;"><p style="margin: 0; font-size: 1.3rem; font-weight: bold;">a</p></span>
                <p style="margin: 0; font-size: 1.3rem; font-weight: bold;" id="destinoVueltaPalabra"></p>
            </div>
        </div>

        <div class="sort-controls">
            <button class="sort-button active" onclick="sortFlights('time', 'vuelta')">Horario</button>
            <button class="sort-button" onclick="sortFlights('duration', 'vuelta')">Duración</button>
            <button class="sort-button" onclick="sortFlights('price', 'vuelta')">Precio</button>
        </div>

        <div class="loader" id="loading-vuelta"></div>

        <div class="container">
            <div class="flight-cards-container" id="vueltaFlightCardsContainer">
                <!-- Flight cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentCurrency = 'CLP';
        let idaFlights = [];
        let vueltaFlights = [];
        let currentIdaSortMethod = 'time';
        let currentVueltaSortMethod = 'time';
        const conversionRate = 850; // Example rate: 1 USD = 850 CLP

        function inicializar() {
            // Show loading indicators
            document.getElementById('loading-ida').style.display = 'block';
            document.getElementById('loading-vuelta').style.display = 'block';
            
            // Display origin and destination
            mostrarPalabras();
            
            // Generate flight data
            generateFlightData();
            
            // Sort and display flights
            sortFlights('time', 'ida');
            sortFlights('time', 'vuelta');
            
            // Hide loading after a short delay to simulate API fetch
            setTimeout(() => {
                document.getElementById('loading-ida').style.display = 'none';
                document.getElementById('loading-vuelta').style.display = 'none';
            }, 800);
        }

        function mostrarPalabras() {
            // Get origin and destination from localStorage or use defaults
            const origenTexto = localStorage.getItem("origenBuscar") || "Santiago";
            const destinoTexto = localStorage.getItem("destinoBuscar") || "Concepción";

            // Set for Ida (outbound)
            document.getElementById("origenIdaPalabra").textContent = ` ${origenTexto}`;
            document.getElementById("destinoIdaPalabra").textContent = ` ${destinoTexto}`;
            
            // Set for Vuelta (return) - swap origin and destination
            document.getElementById("origenVueltaPalabra").textContent = ` ${destinoTexto}`;
            document.getElementById("destinoVueltaPalabra").textContent = ` ${origenTexto}`;
            
            return { origen: origenTexto, destino: destinoTexto };
        }

        function generateFlightData() {
            const { origen, destino } = mostrarPalabras();
            
            // Define flight durations based on common routes in Chile (in minutes)
            const duracionesRutas = {
                "SantiagoConepción": 70,     // 1h 10m
                "SantiagoPuerto Montt": 105, // 1h 45m
                "SantiagoAntofagasta": 120,  // 2h
                "SantiagoLa Serena": 60,     // 1h
                "SantiagoArica": 150,        // 2h 30m
                "ConcepciónSantiago": 70,    // 1h 10m
                "ValparaísoSantiago": 45,    // 45m
                "PuntaArenasSantiago": 210,  // 3h 30m
                "default": 90                // Default 1h 30m
            };
            
            // Determine flight duration based on origin and destination
            const rutaClaveIda = `${origen}${destino}`;
            const baseDurationIda = duracionesRutas[rutaClaveIda] || duracionesRutas.default;
            
            const rutaClaveVuelta = `${destino}${origen}`;
            const baseDurationVuelta = duracionesRutas[rutaClaveVuelta] || duracionesRutas.default;
            
            // Get current date/time
            const now = new Date();
            const baseTimeIda = new Date(now);
            baseTimeIda.setMinutes(baseTimeIda.getMinutes() + 40); // First flight in 40 minutes
            
            const baseTimeVuelta = new Date(now);
            baseTimeVuelta.setDate(baseTimeVuelta.getDate() + 2); // Return flights 2 days later
            
            // Clear previous flight data
            idaFlights = [];
            vueltaFlights = [];
            
            // Generate outbound flights
            for (let i = 0; i < 8; i++) {
                // Calculate departure time with some variations
                const departureTime = new Date(baseTimeIda);
                departureTime.setHours(departureTime.getHours() + i * 2 + Math.floor(Math.random() * 2));
                
                // Add some variation to flight duration
                const durationVariation = Math.floor(Math.random() * 40) - 10; // -10 to +30 minutes
                const actualDuration = baseDurationIda + durationVariation;
                
                // Calculate arrival time
                const arrivalTime = new Date(departureTime);
                arrivalTime.setMinutes(arrivalTime.getMinutes() + actualDuration);
                
                // Price calculation with Chilean prices
                const basePriceCLP = Math.round(22000 + Math.floor(Math.random() * 5000));
                const priceUSD = (basePriceCLP / conversionRate).toFixed(2);
                
                // Randomly assign operator for some flights
                const hasOperator = Math.random() > 0.7;
                const operator = hasOperator ? "JetSur" : null;
                
                // Create flight object
                const flight = {
                    id: i + 1,
                    departureTime: departureTime,
                    arrivalTime: arrivalTime,
                    duration: actualDuration,
                    priceCLP: basePriceCLP,
                    priceUSD: priceUSD,
                    operator: operator
                };
                
                idaFlights.push(flight);
            }
            
            // Generate return flights
            for (let i = 0; i < 8; i++) {
                // Calculate departure time with some variations
                const departureTime = new Date(baseTimeVuelta);
                departureTime.setHours(departureTime.getHours() + i * 3 + Math.floor(Math.random() * 2));
                
                // Add some variation to flight duration
                const durationVariation = Math.floor(Math.random() * 50) - 15; // -15 to +35 minutes
                const actualDuration = baseDurationVuelta + durationVariation;
                
                // Calculate arrival time
                const arrivalTime = new Date(departureTime);
                arrivalTime.setMinutes(arrivalTime.getMinutes() + actualDuration);
                
                // Price calculation with Chilean prices
                const basePriceCLP = Math.round(20000 + Math.floor(Math.random() * 5000));
                const priceUSD = (basePriceCLP / conversionRate).toFixed(2);
                
                // Randomly assign operator for some flights
                const hasOperator = Math.random() > 0.6;
                const operator = hasOperator ? "JetSur" : null;
                
                // Create flight object
                const flight = {
                    id: i + 1,
                    departureTime: departureTime,
                    arrivalTime: arrivalTime,
                    duration: actualDuration,
                    priceCLP: basePriceCLP,
                    priceUSD: priceUSD,
                    operator: operator
                };
                
                vueltaFlights.push(flight);
            }
        }
        
        function formatTime(date) {
            // Format time as 12-hour with AM/PM
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            hours = hours % 12;
            hours = hours ? hours : 12; // Convert '0' to '12' in 12-hour format
            
            return `${hours}:${minutes} ${ampm}`;
        }
        
        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }
        
        function createFlightCard(flight, tripType) {
            const card = document.createElement('div');
            card.className = 'flight-card';
            card.setAttribute('data-flight-id', flight.id);
            
            // Set destination page based on trip type
            const destinationPage = tripType === 'ida' ? 'tarifa2.html' : 'dat.html';
            card.onclick = function() { window.location.href = destinationPage; };
            
            let operatorHTML = '';
            if (flight.operator) {
                operatorHTML = `
                <div class="operator">
                    <span>Operado por</span> <br>
                    <span class="operator-name">${flight.operator}</span>
                </div>`;
            }
            
            const price = currentCurrency === 'CLP' ? 
                `<span class="currency">CLP</span><span class="amount">${flight.priceCLP.toLocaleString()}</span>` : 
                `<span class="currency">USD</span><span class="amount">${flight.priceUSD}</span>`;
            
            card.innerHTML = `
                <div class="flight-times">
                    <div class="time">
                        <span style="font-weight: bold; font-size: 1.2rem;">${formatTime(flight.departureTime)}</span>
                    </div>
            
                    <section style="display: flex; flex-direction: column; justify-content: center;">
                        <div class="duration">
                            <span class="direct">Directo</span>
                            <span class="time">${formatDuration(flight.duration)}</span>
                        </div>
                        <div style="border-style:dashed; border-width: 1px 0px; width: 100%; margin-top: 4%; border-color: #888;"></div>
                    </section>
            
                    <div class="time">
                        <span style="font-weight: bold; font-size: 1.2rem;">${formatTime(flight.arrivalTime)}</span>
                    </div>
                </div>
                
                ${operatorHTML}
            
                <div class="price">
                    <span>Desde</span>
                </div>
            
                <div class="price-display">
                    ${price}
                </div>`;
                
            return card;
        }
        
        function toggleCurrency() {
            currentCurrency = currentCurrency === 'CLP' ? 'USD' : 'CLP';
            document.getElementById('currencyIndicator').textContent = currentCurrency === 'CLP' ? 'CLP/USD' : 'USD/CLP';
            
            // Refresh display with new currency for both tabs
            displayFlights('ida');
            displayFlights('vuelta');
        }
        
        function sortFlights(method, tripType) {
            // Update active button for the current tab
            const buttons = document.querySelectorAll(`#${tripType}-section .sort-button`);
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            const currentButton = document.querySelector(`#${tripType}-section .sort-button[onclick="sortFlights('${method}', '${tripType}')"]`);
            if (currentButton) {
                currentButton.classList.add('active');
            }
            
            // Set current sort method for the trip type
            if (tripType === 'ida') {
                currentIdaSortMethod = method;
            } else {
                currentVueltaSortMethod = method;
            }
            
            // Get correct flight array
            const flights = tripType === 'ida' ? idaFlights : vueltaFlights;
            
            // Sort flights based on selected method
            switch(method) {
                case 'time':
                    flights.sort((a, b) => a.departureTime - b.departureTime);
                    break;
                case 'duration':
                    flights.sort((a, b) => a.duration - b.duration);
                    break;
                case 'price':
                    flights.sort((a, b) => a.priceCLP - b.priceCLP);
                    break;
            }
            
            displayFlights(tripType);
        }
        
        function displayFlights(tripType) {
            const container = document.getElementById(`${tripType}FlightCardsContainer`);
            container.innerHTML = '';
            
            // Get correct flight array
            const flights = tripType === 'ida' ? idaFlights : vueltaFlights;
            
            // Display sorted flights
            flights.forEach(flight => {
                const card = createFlightCard(flight, tripType);
                container.appendChild(card);
            });
        }
        
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Hide all tab content
            document.querySelectorAll('.trip-type').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-section`).classList.add('active');
            document.getElementById(`promo-${tabName}`).classList.add('active');
        }
    </script>
</body>
</html>